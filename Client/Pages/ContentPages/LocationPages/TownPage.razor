@implements IDisposable
@if (allState.ShowTown)
{
	<div class="container mt-5">
		<div class="row">
			<div class="col-lg-12">
				<div class="card">
					<div class="card-header">
						<h4 class="float-start">Towns</h4>
						<button class="btn btn-outline-success float-end" @onclick="AddButtonClicked">
							<i class="bi bi-plus-circle-dotted"></i>
						</button>
					</div>
					<div class="card-header" style="max-height:580px; overflow-x:hidden; overflow-y:scroll;">
						<div class="card-body">
							<table class="table table-striped">
								<thead>
									<tr>
										<th scope="col">#</th>
										<th scope="col">Id</th>
										<th scope="col">City</th>
										<th scope="col">Town</th>
										<th scope="col">Action</th>
									</tr>
								</thead>
								<tbody>
									@if (Towns is not null)
									{
										int count = 1;
										foreach (var item in Towns)
										{
											<tr scope="row">
												<td>@count</td>
												<td>@item.Id</td>
												<td>@item.City!.Name</td>
												<td>@item.Name</td>
												<td>
													<i class="bi bi-pencil text-info" id="cursorStyle" @onclick="() => EditClicked(item)"></i>
													<i class="bi bi-trash text-danger" id="cursorStyle" @onclick="() => DeleteClicked(item)"></i>
												</td>
											</tr>
											count++;
										}
									}
									else
									{
										<tr>
											<td colspan="4"><div class="alert alert-info text-center">No Town added yet!</div></td>
										</tr>
									}
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
}

<style>
	#cursorStyle {
		cursor: pointer
	}
</style>
<TownDialog @ref="townDialog"
			HandleSaveOperationEvent="HandleSaveOperationEvent"
			Town="Town"
			Cities="Cities" />

@code {
    @code {
        // Properties
        public string Title { get; set; } = "Add";
        TownDialog? townDialog;
        Town Town = new();
        public List<City> Cities { get; set; } = new();
        public List<Town> Towns { get; set; } = new();

        // Lifecycle Methods
        protected async override Task OnInitializedAsync()
        {
            await GetCities();
            await GetTowns();
            allState.Action += StateHasChanged;
        }

        // Data Methods
        private async Task GetCities()
        {
            Cities = await cityService.GetAll(Constants.CityBaseUrl);
        }

        private async Task GetTowns()
        {
            Towns = await townService.GetAll(Constants.TownBaseUrl);
        }

        // Dialog Methods
        void AddButtonClicked()
        {
            townDialog?.ChangeTitle("Add");
            Town = new();
            OpenDialog();
        }

        void OpenDialog()
        {
            townDialog?.OpenDialog();
        }

        // CRUD Operations
        private async Task HandleSaveOperationEvent(Town town)
        {
            bool successCheck = false;

            if (town.Id > 0)
            {
                // Update existing town
                var result = await townService.Update(town, Constants.TownBaseUrl);
                successCheck = await DisplayMessage(result.Flag, result.Message);
            }
            else
            {
                // Insert new town
                var response = await townService.Insert(town, Constants.TownBaseUrl);
                successCheck = await DisplayMessage(response.Flag, response.Message);
            }

            if (successCheck)
            {
                Town = new();
                await GetTowns();
                townDialog?.ChangeTitle("Add");
            }
        }

        private void EditClicked(Town town)
        {
            townDialog?.ChangeTitle("Update");
            Town = town;
            OpenDialog();
        }

        private async Task DeleteClicked(Town town)
        {
            bool confirm = await dialogService.ConfirmAsync($"Are you sure you wanna delete {town.Name}?", "Confirm Delete");

            if (!confirm) return;

            var response = await townService.DeleteById(town.Id, Constants.TownBaseUrl);
            var result = await DisplayMessage(response.Flag, response.Message);
            if (result)
        {
            await GetTowns();
        }
    }

    // Helper Methods
    private async Task<bool> DisplayMessage(bool flag, string message)
    {
        if (flag)
        {
            await dialogService.AlertAsync(message, "Success Operation");
            return true;
        }
        else
        {
            await dialogService.AlertAsync(message, "Alert!");
            return false;
        }
    }

    // Cleanup
    public void Dispose()
    {
        allState.Action -= StateHasChanged;
    }
}
}
